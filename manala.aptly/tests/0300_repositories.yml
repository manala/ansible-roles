---

- name: "{{ test }}"
  hosts: debian
  become: true
  vars:
    manala_aptly_config:
      - rootDir: /tmp/aptly
      - architectures:
          - amd64
    manala_aptly_repositories:
      - name:         foo
        comment:      Foo
        component:    main
        distribution: jessie
        origin:       Bar
        label:        Bar
  pre_tasks:
    - include: pre_tasks/aptly.yml
    - copy:
        dest: /etc/apt/preferences.d/aptly
        content: |
          Package:      aptly*
          Pin:          origin repo.aptly.info
          Pin-Priority: 900
    - command: gpg --allow-secret-key-import --import {{ playbook_dir }}/fixtures/gpg/private.asc
      args:
        creates: ~/.gnupg/trustdb.gpg
  roles:
    - manala.aptly
  post_tasks:
    - name: Goss
      command: goss --gossfile {{ test }}.goss.yml validate
