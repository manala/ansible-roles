---

- name: "{{ test }}"
  hosts: debian
  become: true
  vars:
    manala_aptly_config:
      - rootDir: /tmp/aptly
      - architectures:
          - amd64
    manala_aptly_repositories:
      - name:         foo
        comment:      Foo
        component:    main
        distribution: jessie
        origin:       Bar
        label:        Bar
  pre_tasks:
    - import_tasks: pre_tasks/aptly.yml
    - copy:
        dest: /etc/apt/preferences.d/aptly
        content: |
          Package:      aptly*
          Pin:          origin repo.aptly.info
          Pin-Priority: 900
    # See: https://www.aptly.info/doc/feature/pgp-providers/
    - block:
        - apt:
            name:
              - gnupg1
              - gpgv1
            install_recommends: false
          when: ansible_distribution_release == 'stretch'
        - command: gpg1 --allow-secret-key-import --import {{ playbook_dir }}/fixtures/gpg/private.asc
          args:
            creates: ~/.gnupg/trustdb.gpg
      when: ansible_distribution_release == 'stretch'
    - block:
        - command: gpg --allow-secret-key-import --import {{ playbook_dir }}/fixtures/gpg/private.asc
          args:
            creates: ~/.gnupg/trustdb.gpg
      when: ansible_distribution_release != 'stretch'
  roles:
    - manala.aptly
  post_tasks:
    - name: Goss
      command: goss --gossfile {{ test }}.goss.yml validate
