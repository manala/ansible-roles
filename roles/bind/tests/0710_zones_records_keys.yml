---

- name: "{{ test }}"
  hosts: debian
  become: true
  vars:
    manala_bind_configs:
      - file:    named.conf.local
        content: |
                 key "rndc-test-key" {
                   algorithm hmac-md5;
                   secret "TvRkgbDoZrLhuRzabMO/Fw=="; # DO NOT USE THIS SECRET.
                 };

                 controls {
                   inet 127.0.0.1 port 953
                   allow { 127.0.0.1; } keys { "rndc-test-key"; };
                 };

                 zone "foo-keyed.local" {
                   type master;
                   file "{{ 'foo-keyed.local'|manala_bind_zone_file }}";
                   allow-update { key rndc-test-key;};
                 };

    manala_bind_zones:
      - zone:    foo-keyed.local
        dynamic: true
        content: |
                 @  IN SOA ns.foo-keyed.local. contact.foo-keyed.local. (
                             1       ; serial
                             604800  ; refresh (1 week)
                             86400   ; retry (1 day)
                             2419200 ; expire (4 weeks)
                             86400   ; minimum (1 day)
                             )
                 @  IN NS  ns.foo-keyed.local.
                 ns IN A   172.16.1.1
        records_default:
          key_name:   rndc-test-key
          key_secret: "TvRkgbDoZrLhuRzabMO/Fw=="
          key_algorithm: "hmac-md5"
        records:
          - record:     bar-key
            value:      172.16.1.124
  roles:
    - manala.bind
  post_tasks:
    - apt:
        name:
          - bind9-host
        install_recommends: false
    - name: Goss
      command: goss --gossfile {{ test }}.goss.yml validate
