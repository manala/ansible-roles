{%- import '_macros.j2' as macros with context -%}

{%- set config = manala_ssh_config_sshd -%}

#	$OpenBSD: sshd_config,v 1.100 2016/08/15 12:32:04 naddy Exp $

# This is the sshd server system-wide configuration file.  See
# sshd_config(5) for more information.

# This sshd was compiled with PATH=/usr/bin:/bin:/usr/sbin:/sbin

# The strategy used for options in the default sshd_config shipped with
# OpenSSH is to specify options with their default value where
# possible, but leave them commented.  Uncommented options override the
# default value.

{{ macros.config_row(config, 'Port', '#Port 22', 0, true) }}
{{ macros.config_row(config, 'AddressFamily', '#AddressFamily any', 0, true) }}
{{ macros.config_row(config, 'ListenAddress', '#ListenAddress 0.0.0.0
#ListenAddress ::', 0, true) }}

{{ macros.config_row(config, 'HostKey', '#HostKey /etc/ssh/ssh_host_rsa_key
#HostKey /etc/ssh/ssh_host_ecdsa_key
#HostKey /etc/ssh/ssh_host_ed25519_key', 0, true) }}

# Ciphers and keying
{{ macros.config_row(config, 'RekeyLimit', '#RekeyLimit default none', 0, true) }}

# Logging
{{ macros.config_row(config, 'SyslogFacility', '#SyslogFacility AUTH', 0, true) }}
{{ macros.config_row(config, 'LogLevel', '#LogLevel INFO', 0, true) }}

# Authentication:

{{ macros.config_row(config, 'LoginGraceTime', '#LoginGraceTime 2m', 0, true) }}
{{ macros.config_row(config, 'PermitRootLogin', '#PermitRootLogin prohibit-password', 0, true) }}
{{ macros.config_row(config, 'StrictModes', '#StrictModes yes', 0, true) }}
{{ macros.config_row(config, 'MaxAuthTries', '#MaxAuthTries 6', 0, true) }}
{{ macros.config_row(config, 'MaxSessions', '#MaxSessions 10', 0, true) }}

{{ macros.config_row(config, 'PubkeyAuthentication', '#PubkeyAuthentication yes', 0, true) }}

# Expect .ssh/authorized_keys2 to be disregarded by default in future.
{{ macros.config_row(config, 'AuthorizedKeysFile', '#AuthorizedKeysFile	.ssh/authorized_keys .ssh/authorized_keys2', 0, true) }}

{{ macros.config_row(config, 'AuthorizedPrincipalsFile', '#AuthorizedPrincipalsFile none', 0, true) }}

{{ macros.config_row(config, 'AuthorizedKeysCommand', '#AuthorizedKeysCommand none', 0, true) }}
{{ macros.config_row(config, 'AuthorizedKeysCommandUser', '#AuthorizedKeysCommandUser nobody', 0, true) }}

# For this to work you will also need host keys in /etc/ssh/ssh_known_hosts
{{ macros.config_row(config, 'HostbasedAuthentication', '#HostbasedAuthentication no', 0, true) }}
# Change to yes if you don't trust ~/.ssh/known_hosts for
# HostbasedAuthentication
{{ macros.config_row(config, 'IgnoreUserKnownHosts', '#IgnoreUserKnownHosts no', 0, true) }}
# Don't read the user's ~/.rhosts and ~/.shosts files
{{ macros.config_row(config, 'IgnoreRhosts', '#IgnoreRhosts yes', 0, true) }}

# To disable tunneled clear text passwords, change to no here!
{{ macros.config_row(config, 'PasswordAuthentication', '#PasswordAuthentication yes', 0, true) }}
{{ macros.config_row(config, 'PermitEmptyPasswords', '#PermitEmptyPasswords no', 0, true) }}

# Change to yes to enable challenge-response passwords (beware issues with
# some PAM modules and threads)
{{ macros.config_row(config, 'ChallengeResponseAuthentication', false) }}

# Kerberos options
{{ macros.config_row(config, 'KerberosAuthentication', '#KerberosAuthentication no', 0, true) }}
{{ macros.config_row(config, 'KerberosOrLocalPasswd', '#KerberosOrLocalPasswd yes', 0, true) }}
{{ macros.config_row(config, 'KerberosTicketCleanup', '#KerberosTicketCleanup yes', 0, true) }}
{{ macros.config_row(config, 'KerberosGetAFSToken', '#KerberosGetAFSToken no', 0, true) }}

# GSSAPI options
{{ macros.config_row(config, 'GSSAPIAuthentication', '#GSSAPIAuthentication no', 0, true) }}
{{ macros.config_row(config, 'GSSAPICleanupCredentials', '#GSSAPICleanupCredentials yes', 0, true) }}
{{ macros.config_row(config, 'GSSAPIStrictAcceptorCheck', '#GSSAPIStrictAcceptorCheck yes', 0, true) }}
{{ macros.config_row(config, 'GSSAPIKeyExchange', '#GSSAPIKeyExchange no', 0, true) }}

# Set this to 'yes' to enable PAM authentication, account processing,
# and session processing. If this is enabled, PAM authentication will
# be allowed through the ChallengeResponseAuthentication and
# PasswordAuthentication.  Depending on your PAM configuration,
# PAM authentication via ChallengeResponseAuthentication may bypass
# the setting of "PermitRootLogin without-password".
# If you just want the PAM account and session checks to run without
# PAM authentication, then enable this but set PasswordAuthentication
# and ChallengeResponseAuthentication to 'no'.
{{ macros.config_row(config, 'UsePAM', true) }}

{{ macros.config_row(config, 'AllowAgentForwarding', '#AllowAgentForwarding yes', 0, true) }}
{{ macros.config_row(config, 'AllowTcpForwarding', '#AllowTcpForwarding yes', 0, true) }}
{{ macros.config_row(config, 'GatewayPorts', '#GatewayPorts no', 0, true) }}
{{ macros.config_row(config, 'X11Forwarding', true) }}
{{ macros.config_row(config, 'X11DisplayOffset', '#X11DisplayOffset 10', 0, true) }}
{{ macros.config_row(config, 'X11UseLocalhost', '#X11UseLocalhost yes', 0, true) }}
{{ macros.config_row(config, 'PermitTTY', '#PermitTTY yes', 0, true) }}
{{ macros.config_row(config, 'PrintMotd', false) }}
{{ macros.config_row(config, 'PrintLastLog', '#PrintLastLog yes', 0, true) }}
{{ macros.config_row(config, 'TCPKeepAlive', '#TCPKeepAlive yes', 0, true) }}
{{ macros.config_row(config, 'UseLogin', '#UseLogin no', 0, true) }}
{{ macros.config_row(config, 'UsePrivilegeSeparation', '#UsePrivilegeSeparation sandbox', 0, true) }}
{{ macros.config_row(config, 'PermitUserEnvironment', '#PermitUserEnvironment no', 0, true) }}
{{ macros.config_row(config, 'Compression', '#Compression delayed', 0, true) }}
{{ macros.config_row(config, 'ClientAliveInterval', '#ClientAliveInterval 0', 0, true) }}
{{ macros.config_row(config, 'ClientAliveCountMax', '#ClientAliveCountMax 3', 0, true) }}
{{ macros.config_row(config, 'UseDNS', '#UseDNS no', 0, true) }}
{{ macros.config_row(config, 'PidFile', '#PidFile /var/run/sshd.pid', 0, true) }}
{{ macros.config_row(config, 'MaxStartups', '#MaxStartups 10:30:100', 0, true) }}
{{ macros.config_row(config, 'PermitTunnel', '#PermitTunnel no', 0, true) }}
{{ macros.config_row(config, 'ChrootDirectory', '#ChrootDirectory none', 0, true) }}
{{ macros.config_row(config, 'VersionAddendum', '#VersionAddendum none', 0, true) }}

# no default banner path
{{ macros.config_row(config, 'Banner', '#Banner none', 0, true) }}

# Allow client to pass locale environment variables
{{ macros.config_row(config, 'AcceptEnv', 'LANG LC_*') }}

# override default of no subsystems
{{ macros.config_row(config, 'Subsystem', 'sftp	/usr/lib/openssh/sftp-server') }}

# Example of overriding settings on a per-user basis
#Match User anoncvs
#	X11Forwarding no
#	AllowTcpForwarding no
#	PermitTTY no
#	ForceCommand cvs server
{{ macros.config(config, [
    'Port',
    'AddressFamily',
    'ListenAddress',
    'HostKey',
    'RekeyLimit',
    'SyslogFacility',
    'LogLevel',
    'LoginGraceTime',
    'PermitRootLogin',
    'StrictModes',
    'MaxAuthTries',
    'MaxSessions',
    'PubkeyAuthentication',
    'AuthorizedKeysFile',
    'AuthorizedPrincipalsFile',
    'AuthorizedKeysCommand',
    'AuthorizedKeysCommandUser',
    'HostbasedAuthentication',
    'IgnoreUserKnownHosts',
    'IgnoreRhosts',
    'PasswordAuthentication',
    'PermitEmptyPasswords',
    'ChallengeResponseAuthentication',
    'KerberosAuthentication',
    'KerberosOrLocalPasswd',
    'KerberosTicketCleanup',
    'KerberosGetAFSToken',
    'GSSAPIAuthentication',
    'GSSAPICleanupCredentials',
    'GSSAPIStrictAcceptorCheck',
    'GSSAPIKeyExchange',
    'UsePAM',
    'AllowAgentForwarding',
    'AllowTcpForwarding',
    'GatewayPorts',
    'X11Forwarding',
    'X11DisplayOffset',
    'X11UseLocalhost',
    'PermitTTY',
    'PrintMotd',
    'PrintLastLog',
    'TCPKeepAlive',
    'UseLogin',
    'UsePrivilegeSeparation',
    'PermitUserEnvironment',
    'Compression',
    'ClientAliveInterval',
    'ClientAliveCountMax',
    'UseDNS',
    'PidFile',
    'MaxStartups',
    'PermitTunnel',
    'ChrootDirectory',
    'VersionAddendum',
    'Banner',
    'AcceptEnv',
    'Subsystem'
]) }}
