name: Molecule

on:
  workflow_call:
    inputs:
      debug:
        type: boolean
        required: false
        default: false
      scenario:
        type: string
        required: true
      versions:
        type: string
        required: false
        default: '[null]'

jobs:
  molecule:
    name: Molecule
    runs-on: ubuntu-22.04
    env:
      MANALA_DOCKER_CACHE_FROM: type=gha,scope=docker
      MANALA_DOCKER_CACHE_TO: type=gha,mode=max,scope=docker
    strategy:
      matrix:
        version: ${{ fromJson(inputs.versions) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Env
        run: |
          cp .env.dist .env

      - name: AppArmor
        run: |
          # Disable mysqld profile
          echo "/usr/sbin/mysqld { }" | sudo tee /etc/apparmor.d/usr.sbin.mysqld
          sudo apparmor_parser -v -R /etc/apparmor.d/usr.sbin.mysqld

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Expose ACTIONS_CACHE_URL & ACTIONS_RUNTIME_TOKEN
      # to be consumed by docker github action cache
      # See: https://docs.docker.com/build/cache/backends/gha/
      - name: Expose GitHub Runtime
        uses: crazy-max/ghaction-github-runtime@v2

      - name: Molecule
        run: |
          make molecule.converge SCENARIO=${{ inputs.scenario }}${{ matrix.version && format('.{0}', matrix.version) || '' }}

      - name: Debug
        uses: mxschmitt/action-tmate@v3
        if: ${{ inputs.debug && always() }}
        timeout-minutes: 15
