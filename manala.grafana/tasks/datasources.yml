---

- name: datasources > List
  uri:
    url:              "{{ manala_grafana_api_url }}/api/datasources"
    force_basic_auth: true
    user:             "{{ manala_grafana_api_user }}"
    password:         "{{ manala_grafana_api_password }}"
    headers:
      Content-Type: application/json
  register: __manala_grafana_dashboards_list_output

- name: datasources > Update
  uri:
    url:              "{{ manala_grafana_api_url }}/api/datasources/{{ item[0].id }}"
    method:           PUT
    body:             "{{ item[1]|to_json }}"
    force_basic_auth: true
    user:             "{{ manala_grafana_api_user }}"
    password:         "{{ manala_grafana_api_password }}"
    headers:
      Content-Type: application/json
  with_nested:
    - "{{ __manala_grafana_dashboards_list_output.json|default([]) }}"
    - "{{ manala_grafana_datasources }}"
  register: __manala_grafana_datasources_update_output
  failed_when: "'Datasource updated' not in __manala_grafana_datasources_update_output.json.message"
  when: item[0].name == item[1].name

- name: datasources > Create
  uri:
    url:              "{{ manala_grafana_api_url }}/api/datasources"
    method:           POST
    body:             "{{ item|to_json }}"
    force_basic_auth: true
    user:             "{{ manala_grafana_api_user }}"
    password:         "{{ manala_grafana_api_password }}"
    headers:
      Content-Type: application/json
  with_items: "{{ manala_grafana_datasources }}"
  register: __manala_grafana_datasources_create_output
  failed_when: "'Datasource added' not in __manala_grafana_datasources_create_output.json.message"
  when: item.name not in __manala_grafana_dashboards_list_output.json|map(attribute='name')|list

- name: datasources > Delete
  uri:
    url:              "{{ manala_grafana_api_url }}/api/datasources/{{ item.id }}"
    method:           DELETE
    force_basic_auth: true
    user:             "{{ manala_grafana_api_user }}"
    password:         "{{ manala_grafana_api_password }}"
    headers:
      Content-Type: application/json
  with_items: "{{ __manala_grafana_dashboards_list_output.json|default([]) }}"
  register: __manala_grafana_datasources_delete_output
  failed_when: "'Data source deleted' not in __manala_grafana_datasources_delete_output.json.message"
  when: manala_grafana_datasources_exclusive and item.name not in manala_grafana_datasources|map(attribute='name')|list
