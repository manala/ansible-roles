---

- name: dashboards > List
  uri:
    url:              "{{ manala_grafana_api_url }}/api/search"
    force_basic_auth: true
    user:             "{{ manala_grafana_api_user }}"
    password:         "{{ manala_grafana_api_password }}"
    headers:
      Content-Type: application/json
  register: __manala_grafana_dashboards_output
  when: manala_grafana_dashboards_exclusive

- name: dashboards > Delete
  uri:
    url:              "{{ manala_grafana_api_url }}/api/dashboards/{{ item.uri }}"
    method:           DELETE
    force_basic_auth: true
    user:             "{{ manala_grafana_api_user }}"
    password:         "{{ manala_grafana_api_password }}"
    headers:
      Content-Type: application/json
  with_items: "{{ __manala_grafana_dashboards_output.json|default([]) }}"
  register: __manala_grafana_dashboards_delete_output
  failed_when: "'Dashboard not found' in __manala_grafana_dashboards_delete_output.json.message"
  when: manala_grafana_dashboards_exclusive

- name: dashboards > Import
  uri:
    url:              "{{ manala_grafana_api_url }}/api/dashboards/import"
    method:           POST
    body:             "{{
      {
        'dashboard': lookup('file', item.template)|from_json,
        'overwrite': item.overwrite|default(true),
        'inputs': item.inputs|default([])
      }|to_json
    }}"
    force_basic_auth: true
    user:             "{{ manala_grafana_api_user }}"
    password:         "{{ manala_grafana_api_password }}"
    headers:
      Content-Type: application/json
  with_items: "{{ manala_grafana_dashboards }}"
  register: __manala_grafana_dashboards_import_output
  failed_when: not __manala_grafana_dashboards_import_output.json.imported
